using UnityEngine;
using UnityEngine.UI;
using TMPro;
using UnityEngine.EventSystems;
using System.Collections;

/// <summary>
/// G√®re l'affichage et l'interaction avec la carte email.
/// D√©tecte les swipes gauche/droite pour approuver ou rejeter.
/// Effets visuels : contours color√©s, glitch, feux d'artifice.
/// </summary>
public class EmailCardUI : MonoBehaviour, IBeginDragHandler, IDragHandler, IEndDragHandler
{
    [Header("üìß √âl√©ments de Texte")]
    public TextMeshProUGUI expediteurText;
    public TextMeshProUGUI objetText;
    public TextMeshProUGUI corpsText;

    [Header("üéÆ Param√®tres du Swipe")]
    public float swipeThreshold = 150f;
    public float returnSpeed = 10f;

    [Header("üé® Effets Visuels - Contours")]
    [Tooltip("Image de contour/bordure de la carte (doit entourer la carte)")]
    public Image cardOutline;
    
    [Tooltip("Couleur pour approuver (vert)")]
    public Color approveColor = new Color(0.2f, 0.9f, 0.3f, 1f);
    
    [Tooltip("Couleur pour rejeter (rouge)")]
    public Color rejectColor = new Color(0.9f, 0.2f, 0.2f, 1f);

    [Header("‚ú® Effets Sp√©ciaux")]
    [Tooltip("Syst√®me de particules pour les feux d'artifice")]
    public ParticleSystem fireworksEffect;

    [Header("üì≥ Vibration (Mobile)")]
    [Tooltip("Activer les vibrations sur mobile")]
    public bool enableVibration = true;

    // Variables priv√©es
    private Vector2 startDragPosition;
    private RectTransform rectTransform;
    private Canvas canvas;
    private Vector2 originalPosition;
    private bool isDragging = false;

    void Awake()
    {
        rectTransform = GetComponent<RectTransform>();
        canvas = GetComponentInParent<Canvas>();
        originalPosition = rectTransform.anchoredPosition;
    }

    void Start()
    {
        // Cache le contour au d√©marrage
        if (cardOutline != null)
        {
            cardOutline.gameObject.SetActive(false);
        }

        // D√©sactive les particules au d√©marrage
        if (fireworksEffect != null) fireworksEffect.Stop();
    }

    /// <summary>
    /// Affiche un nouvel email dans la carte.
    /// </summary>
    public void AfficherEmail(EmailData email)
    {
        expediteurText.text = "De: " + email.expediteurNom + " <" + email.expediteurEmail + ">";
        objetText.text = "Objet: " + email.objet;
        corpsText.text = email.corpsDuMessage;

        rectTransform.anchoredPosition = originalPosition;
        
        // Reset le contour
        HideOutline();
    }

    void HideOutline()
    {
        if (cardOutline != null)
        {
            cardOutline.gameObject.SetActive(false);
        }
    }

    void ShowOutline(Color color, float intensity)
    {
        if (cardOutline != null)
        {
            cardOutline.gameObject.SetActive(true);
            
            // Applique la couleur avec l'intensit√©
            Color colorWithAlpha = color;
            colorWithAlpha.a = intensity;
            cardOutline.color = colorWithAlpha;
        }
    }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // SYST√àME DE D√âTECTION DU SWIPE
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

    public void OnBeginDrag(PointerEventData eventData)
    {
        startDragPosition = eventData.position;
        isDragging = true;
    }

    public void OnDrag(PointerEventData eventData)
    {
        if (!isDragging) return;

        Vector2 dragDelta = eventData.position - startDragPosition;
        Vector2 newPosition = originalPosition + (dragDelta / canvas.scaleFactor);
        rectTransform.anchoredPosition = new Vector2(newPosition.x, originalPosition.y);

        // Calcule l'intensit√© du swipe (0 √† 1)
        float swipeIntensity = Mathf.Clamp01(Mathf.Abs(dragDelta.x) / swipeThreshold);

        if (dragDelta.x > 50f)
        {
            // Swipe vers la DROITE = Approuver (VERT)
            ShowOutline(approveColor, swipeIntensity);
        }
        else if (dragDelta.x < -50f)
        {
            // Swipe vers la GAUCHE = Rejeter (ROUGE)
            ShowOutline(rejectColor, swipeIntensity);
        }
        else
        {
            // Swipe trop petit, cache le contour
            HideOutline();
        }
    }

    public void OnEndDrag(PointerEventData eventData)
    {
        isDragging = false;
        Vector2 dragDelta = eventData.position - startDragPosition;

        if (Mathf.Abs(dragDelta.x) > swipeThreshold)
        {
            bool approuve = dragDelta.x > 0;
            Debug.Log(approuve ? "‚û°Ô∏è APPROUV√â" : "‚¨ÖÔ∏è REJET√â");

            // Informe le GameManager et r√©cup√®re si c'√©tait correct
            bool wasCorrect = GameManager.Instance.TraiterDecisionAvecRetour(approuve);
            
            // Joue les effets via EffectsManager (centralise tous les effets)
            if (EffectsManager.Instance != null)
            {
                if (wasCorrect)
                {
                    EffectsManager.Instance.PlayCorrectEffect();
                    PlayFireworks();
                }
                else
                {
                    EffectsManager.Instance.PlayWrongEffect();
                }
            }
            
            // Vibration sur mobile
            if (enableVibration)
            {
                if (wasCorrect)
                {
                    Vibrate(50);
                }
                else
                {
                    Vibrate(200);
                }
            }
        }
        
        // Cache le contour
        HideOutline();
    }

    void Update()
    {
        if (!isDragging)
        {
            rectTransform.anchoredPosition = Vector2.Lerp(
                rectTransform.anchoredPosition,
                originalPosition,
                Time.deltaTime * returnSpeed
            );

            if (Vector2.Distance(rectTransform.anchoredPosition, originalPosition) < 1f)
            {
                HideOutline();
            }
        }
    }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // EFFETS SP√âCIAUX
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

    void PlayFireworks()
    {
        if (fireworksEffect != null)
        {
            fireworksEffect.Play();
        }
    }

    void Vibrate(long milliseconds)
    {
        #if UNITY_ANDROID && !UNITY_EDITOR
        try
        {
            using (AndroidJavaClass unityPlayer = new AndroidJavaClass("com.unity3d.player.UnityPlayer"))
            {
                AndroidJavaObject currentActivity = unityPlayer.GetStatic<AndroidJavaObject>("currentActivity");
                AndroidJavaObject vibrator = currentActivity.Call<AndroidJavaObject>("getSystemService", "vibrator");
                vibrator.Call("vibrate", milliseconds);
            }
        }
        catch (System.Exception e)
        {
            Debug.Log("Vibration non disponible: " + e.Message);
        }
        #elif UNITY_IOS && !UNITY_EDITOR
        Handheld.Vibrate();
        #endif
    }
}